<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Timer & Stopwatch App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <style>
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --accent-color: #333333;
            --danger-color: #ff3333;
            --font-main: 'Roboto', sans-serif;
            --btn-hover: #444444;
            --panel-bg: rgba(255, 255, 255, 0.15);
            --dropdown-bg: #1a1a1a;
        }

        body.light-mode {
            --bg-color: #ffffff;
            --text-color: #000000;
            --accent-color: #e0e0e0;
            --btn-hover: #d0d0d0;
            --panel-bg: rgba(0, 0, 0, 0.05);
            --dropdown-bg: #f5f5f5;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
            position: relative;
        }

        /* --- Header --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            z-index: 10;
            height: 70px;
            flex-shrink: 0;
        }

        .header-left, .header-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background-color: var(--panel-bg); }
        .material-icons-outlined { font-size: 28px; }

        /* --- Alarm Menu --- */
        .alarm-menu {
            position: absolute;
            top: 60px; left: 10px;
            background-color: var(--dropdown-bg);
            border: 1px solid var(--accent-color);
            border-radius: 12px;
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 5px;
            min-width: 260px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 200;
        }
        .alarm-menu.show { display: flex; }

        .alarm-option {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; border-radius: 8px; cursor: pointer;
            font-size: 1rem; color: var(--text-color);
        }
        .alarm-option:hover { background-color: var(--panel-bg); }
        .alarm-option.selected { border: 1px solid var(--text-color); font-weight: bold; background-color: var(--panel-bg); }

        /* --- Main Layout --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            padding-bottom: 20px; 
        }

        /* --- Mode Switcher Tabs --- */
        .mode-switch {
            display: flex;
            gap: 30px;
            margin-bottom: 5vh;
            z-index: 5;
        }

        .mode-btn {
            background: none; border: none;
            color: var(--text-color); opacity: 0.4;
            font-size: 1.1rem; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
            padding-bottom: 10px;
            border-bottom: 2px solid transparent;
            display: flex; align-items: center; gap: 8px;
        }
        .mode-btn.active { opacity: 1; border-bottom: 2px solid var(--text-color); }

        /* --- Time Display --- */
        .time-display {
            font-size: 18vw;
            font-weight: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            gap: 2vw;
            transition: transform 0.1s; 
            margin-bottom: 2vh;
            z-index: 1;
        }

        @media (min-width: 768px) { .time-display { font-size: 15vw; gap: 4vw; } }
        @media (min-width: 1400px) { .time-display { font-size: 220px; gap: 60px; } }

        .time-input {
            background: transparent;
            border: none;
            color: inherit;
            font-family: inherit;
            font-size: inherit;
            width: 2ch;
            text-align: center;
            padding: 0; margin: 0;
            line-height: 1;
            -moz-appearance: textfield;
        }
        .time-input::-webkit-outer-spin-button,
        .time-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .time-input:focus { outline: none; background-color: var(--panel-bg); border-radius: 12px; }

        .separator { opacity: 0.5; transform: translateY(-8%); font-weight: 100; }
        .danger-zone input, .danger-zone span { color: var(--danger-color); }

        /* --- Controls --- */
        .controls { display: flex; gap: 25px; margin-top: 4vh; align-items: center; z-index: 5; }
        .btn-round {
            width: 70px; height: 70px; border-radius: 50%;
            border: 2px solid var(--text-color);
            background: transparent; color: var(--text-color);
            font-size: 2rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        @media (min-width: 768px) { .btn-round { width: 80px; height: 80px; } }
        .btn-round:hover { background-color: var(--text-color); color: var(--bg-color); }

        .quick-add-container { 
            display: flex; gap: 10px; margin-top: 2vh; flex-wrap: wrap; 
            justify-content: center; padding: 0 20px; z-index: 5;
        }
        .btn-pill {
            padding: 12px 20px; border-radius: 30px;
            border: 1px solid var(--text-color);
            background: transparent; color: var(--text-color);
            cursor: pointer; font-size: 1rem;
            transition: background 0.2s;
            flex-grow: 1; max-width: 120px;
            text-align: center; touch-action: manipulation;
        }
        .btn-pill:hover { background-color: var(--panel-bg); }

        /* --- Footer --- */
        footer {
            padding: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            /* opacity: 0.7; USUNIĘTE */
            margin-top: auto;
            flex-shrink: 0;
            z-index: 100;
        }
        .footer-logo {
            height: 30px;
            width: auto;
            object-fit: contain;
            transition: opacity 0.3s;
        }

        /* --- FULLSCREEN LOGIC --- */
        .fs-controls {
            display: none;
            position: absolute; top: 20px; right: 20px; gap: 15px; z-index: 999;
            padding-top: env(safe-area-inset-top);
            padding-right: env(safe-area-inset-right);
        }

        /* Krytyczne poprawki dla mobile fullscreen */
        body.fullscreen-active { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            margin: 0; z-index: 9999; background-color: var(--bg-color);
        }
        
        /* Ukrywanie elementów w Fullscreen - ALE NIE STOPKI */
        body.fullscreen-active header,
        body.fullscreen-active .mode-switch,
        body.fullscreen-active .quick-add-container,
        body.fullscreen-active .controls,
        body.fullscreen-active .laps-container,
        body.fullscreen-active #btn-sw-lap { display: none !important; }
        
        body.fullscreen-active .fs-controls { display: flex; }
        body.fullscreen-active main { justify-content: center; height: 100%; padding: 0; }
        
        body.fullscreen-active .time-display { font-size: 28vw; margin: 0; cursor: pointer; }
        body.fullscreen-active .time-input { pointer-events: none; }

        @media (min-width: 768px) { body.fullscreen-active .time-display { font-size: 25vw; } }
        @media (min-width: 1400px) { body.fullscreen-active .time-display { font-size: 400px; } }

        /* Specjalne style dla stopki w Fullscreen */
        body.fullscreen-active footer {
            display: flex !important;
            position: absolute;
            bottom: 20px;
            bottom: max(20px, env(safe-area-inset-bottom));
            left: 0;
            width: 100%;
            justify-content: center;
            pointer-events: none; /* Żeby nie blokowało kliknięć w tło */
        }

        .hidden { display: none !important; }
        
        .laps-container { 
            margin-top: 20px; height: 15vh; overflow-y: auto; 
            width: 90%; max-width: 300px; text-align: center; 
            font-family: monospace; opacity: 0.7; 
        }
        .lap-row { border-bottom:1px solid #333; padding:8px 4px; display:flex; justify-content:space-between; font-size: 1.1rem; }

        @media (max-height: 500px) and (orientation: landscape) {
            header { display: none; }
            .mode-switch { margin-bottom: 10px; }
            .time-display { font-size: 12vw; margin-bottom: 5px; }
            .controls { margin-top: 10px; }
            .quick-add-container { display: none; }
            footer { display: none; } /* Na bardzo małych ekranach w poziomie ukrywamy stopkę, żeby zmieścić czas */
        }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div style="position: relative;">
                <button class="icon-btn" id="btn-alarm" title="Wybierz Dźwięk">
                    <span class="material-icons-outlined">notifications</span>
                </button>
                <div class="alarm-menu" id="alarm-menu">
                    <div class="alarm-option" data-sound="gong" onclick="app.selectSound('gong')">
                        <span>Gong Tybetański</span>
                        <span class="material-icons-outlined" onclick="event.stopPropagation(); app.previewSound('gong')">play_circle</span>
                    </div>
                    <div class="alarm-option" data-sound="bell" onclick="app.selectSound('bell')">
                        <span>Szklany Dzwonek</span>
                        <span class="material-icons-outlined" onclick="event.stopPropagation(); app.previewSound('bell')">play_circle</span>
                    </div>
                    <div class="alarm-option" data-sound="chime" onclick="app.selectSound('chime')">
                        <span>Spokojny Chime</span>
                        <span class="material-icons-outlined" onclick="event.stopPropagation(); app.previewSound('chime')">play_circle</span>
                    </div>
                </div>
            </div>
            
            <button class="icon-btn" onclick="app.toggleMute()" title="Wycisz">
                <span class="material-icons-outlined" id="mute-icon">volume_up</span>
            </button>
        </div>

        <div class="header-right">
             <button class="icon-btn" onclick="app.toggleTheme()" title="Zmień motyw">
                <span class="material-icons-outlined" id="theme-icon">light_mode</span>
            </button>
            <button class="icon-btn" onclick="app.toggleFullscreen()" title="Pełny Ekran">
                <span class="material-icons-outlined">fullscreen</span>
            </button>
        </div>
    </header>

    <div class="fs-controls">
        <button class="icon-btn" onclick="app.toggleTheme()">
            <span class="material-icons-outlined" id="theme-icon-fs">light_mode</span>
        </button>
        <button class="icon-btn" onclick="app.toggleMute()">
            <span class="material-icons-outlined" id="mute-icon-fs">volume_up</span>
        </button>
        <button class="icon-btn" onclick="app.toggleFullscreen()">
            <span class="material-icons-outlined">fullscreen_exit</span>
        </button>
    </div>

    <main id="main-area">
        <div class="mode-switch">
            <button class="mode-btn active" id="tab-timer" onclick="app.setMode('timer')">
                <span class="material-icons-outlined">timer</span> Minutnik
            </button>
            <button class="mode-btn" id="tab-stopwatch" onclick="app.setMode('stopwatch')">
                <span class="material-icons-outlined">shutter_speed</span> Stoper
            </button>
        </div>

        <div id="view-timer">
            <div class="time-display" id="timer-display">
                <input type="number" inputmode="numeric" id="hh" class="time-input" value="00" placeholder="00">
                <span class="separator">:</span>
                <input type="number" inputmode="numeric" id="mm" class="time-input" value="10" placeholder="00">
                <span class="separator">:</span>
                <input type="number" inputmode="numeric" id="ss" class="time-input" value="00" placeholder="00">
            </div>

            <div class="quick-add-container">
                <button class="btn-pill" onclick="app.addTime(30)">+30s</button>
                <button class="btn-pill" onclick="app.addTime(60)">+1m</button>
                <button class="btn-pill" onclick="app.addTime(300)">+5m</button>
            </div>

            <div class="controls">
                <button class="btn-round" id="t-start" onclick="app.toggleTimer()">
                    <span class="material-icons-outlined">play_arrow</span>
                </button>
                <button class="btn-round" onclick="app.resetTimer()">
                    <span class="material-icons-outlined">refresh</span>
                </button>
            </div>
        </div>

        <div id="view-stopwatch" class="hidden">
            <div class="time-display" id="sw-display">
                00 <span class="separator">:</span> 00 <span class="separator">:</span> 00
            </div>
            <div class="controls">
                <button class="btn-round" id="sw-start" onclick="app.toggleStopwatch()">
                    <span class="material-icons-outlined">play_arrow</span>
                </button>
                <button class="btn-pill" id="btn-sw-lap" onclick="app.lap()">Lap</button>
                <button class="btn-round" onclick="app.resetStopwatch()">
                    <span class="material-icons-outlined">refresh</span>
                </button>
            </div>
            <div class="laps-container" id="laps"></div>
        </div>
    </main>

    <footer>
        <img id="company-logo" src="RGB_TC_Color_OnDark.png" alt="Company Logo" class="footer-logo">
    </footer>

    <script>
        // --- SCREEN WAKE LOCK ---
        let wakeLock = null;
        async function activateWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) { console.log('Wake Lock Error', err); }
            }
        }
        function releaseWakeLock() {
            // Only release if NOT in fullscreen. If in fullscreen, we keep it!
            if (document.body.classList.contains('fullscreen-active')) return;
            
            if (wakeLock !== null) {
                wakeLock.release().then(() => { wakeLock = null; });
            }
        }
        
        // Re-acquire lock on visibility change (tab switch)
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible') {
                if(STATE.timer.running || STATE.stopwatch.running || document.body.classList.contains('fullscreen-active')) {
                    activateWakeLock();
                }
            }
        });

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function createSoftTone(freq, duration, attack=0.05, decay=1.5, vol=0.3) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; 
            osc.frequency.setValueAtTime(freq, t);
            gain.gain.setValueAtTime(0, t);
            gain.gain.linearRampToValueAtTime(vol, t + attack); 
            gain.gain.exponentialRampToValueAtTime(0.001, t + duration); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(t);
            osc.stop(t + duration);
        }

        const SoundGen = {
            gong() {
                createSoftTone(220, 3.5, 0.1, 3.0, 0.4); 
                setTimeout(() => createSoftTone(540, 3.0, 0.2, 2.8, 0.1), 50);
            },
            bell() {
                createSoftTone(1100, 2.0, 0.01, 1.5, 0.25);
                createSoftTone(3300, 1.0, 0.01, 0.8, 0.05);
            },
            chime() {
                createSoftTone(659, 1.5, 0.02, 1.2, 0.25);
                setTimeout(() => createSoftTone(554, 2.5, 0.05, 2.0, 0.25), 400); 
            },
            play(type) {
                if(type === 'gong') this.gong();
                if(type === 'bell') this.bell();
                if(type === 'chime') this.chime();
            }
        };

        // --- APP STATE ---
        const STATE = {
            mode: 'timer',
            theme: 'dark',
            sound: 'gong',
            muted: false,
            timer: { running: false, interval: null, remaining: 600, total: 600 },
            stopwatch: { running: false, interval: null, startT: 0, elapsed: 0 }
        };

        const app = {
            els: {
                inputs: { h: document.getElementById('hh'), m: document.getElementById('mm'), s: document.getElementById('ss') },
                timerDisplay: document.getElementById('timer-display'),
                swDisplay: document.getElementById('sw-display'),
                alarmMenu: document.getElementById('alarm-menu'),
                muteIcons: [document.getElementById('mute-icon'), document.getElementById('mute-icon-fs')],
                themeIcons: [document.getElementById('theme-icon'), document.getElementById('theme-icon-fs')],
                logo: document.getElementById('company-logo')
            },

            init() {
                document.getElementById('btn-alarm').addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.els.alarmMenu.classList.toggle('show');
                });
                document.addEventListener('click', (e) => {
                    if(!this.els.alarmMenu.contains(e.target)) this.els.alarmMenu.classList.remove('show');
                });

                Object.values(this.els.inputs).forEach(inp => {
                    inp.addEventListener('change', () => this.syncTimer());
                    inp.addEventListener('input', () => { if(inp.value.length > 2) inp.value = inp.value.slice(0,2); });
                    inp.addEventListener('focus', () => { if(STATE.timer.running) this.toggleTimer(); });
                });

                document.body.addEventListener('keydown', (e) => {
                    if(e.code === 'Space') { e.preventDefault(); this.toggleCurrentMode(); }
                });

                // Kliknięcie w zegar w trybie FS pauzuje/startuje
                this.els.timerDisplay.addEventListener('click', () => {
                    if(document.body.classList.contains('fullscreen-active')) this.toggleTimer();
                });
                this.els.swDisplay.addEventListener('click', () => {
                    if(document.body.classList.contains('fullscreen-active')) this.toggleStopwatch();
                });
                
                // Swipe Gestures
                this.bindGestures();

                this.syncTimer();
                this.selectSound('gong'); 
                this.bindFullscreenEvents();
            },

            bindGestures() {
                let touchStartX = 0;
                let touchEndX = 0;
                const mainArea = document.getElementById('main-area');

                mainArea.addEventListener('touchstart', e => {
                    touchStartX = e.changedTouches[0].screenX;
                }, {passive: true});

                mainArea.addEventListener('touchend', e => {
                    touchEndX = e.changedTouches[0].screenX;
                    this.handleSwipe(touchStartX, touchEndX);
                }, {passive: true});
            },

            handleSwipe(start, end) {
                if (document.body.classList.contains('fullscreen-active')) return; 
                const threshold = 50;
                if (end < start - threshold) {
                    // Swiped Left -> Stopwatch
                    this.setMode('stopwatch');
                }
                if (end > start + threshold) {
                    // Swiped Right -> Timer
                    this.setMode('timer');
                }
            },

            bindFullscreenEvents() {
                const events = ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'];
                events.forEach(evt => {
                    document.addEventListener(evt, () => {
                        const isFS = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
                        if (!isFS) {
                            document.body.classList.remove('fullscreen-active');
                            // Release lock if nothing is running
                            if (!STATE.timer.running && !STATE.stopwatch.running) releaseWakeLock();
                        }
                    });
                });
            },

            toggleCurrentMode() {
                if(STATE.mode === 'timer') this.toggleTimer();
                else this.toggleStopwatch();
            },

            toggleTheme() {
                STATE.theme = STATE.theme === 'dark' ? 'light' : 'dark';
                document.body.classList.toggle('light-mode', STATE.theme === 'light');
                const icon = STATE.theme === 'light' ? 'dark_mode' : 'light_mode';
                this.els.themeIcons.forEach(i => i.innerText = icon);
                
                // Swap Logo
                const logoSrc = STATE.theme === 'light' ? 'RGB_TC_Color_OnLight.png' : 'RGB_TC_Color_OnDark.png';
                this.els.logo.src = logoSrc;
            },

            toggleMute() {
                STATE.muted = !STATE.muted;
                const icon = STATE.muted ? 'volume_off' : 'volume_up';
                this.els.muteIcons.forEach(i => i.innerText = icon);
            },

            toggleFullscreen() {
                const docEl = document.documentElement;
                const isAlreadyFS = !!(document.fullscreenElement || document.webkitFullscreenElement);

                if (!isAlreadyFS) {
                    try {
                        if (docEl.requestFullscreen) docEl.requestFullscreen();
                        else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
                    } catch (e) { console.log("FS API Error"); }
                    document.body.classList.add('fullscreen-active');
                    activateWakeLock(); // Force lock on FS entry
                } else {
                    try {
                        if (document.exitFullscreen) document.exitFullscreen();
                        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                    } catch (e) {}
                    document.body.classList.remove('fullscreen-active');
                }
            },

            setMode(mode) {
                STATE.mode = mode;
                document.getElementById('view-timer').classList.toggle('hidden', mode !== 'timer');
                document.getElementById('view-stopwatch').classList.toggle('hidden', mode !== 'stopwatch');
                document.getElementById('tab-timer').classList.toggle('active', mode === 'timer');
                document.getElementById('tab-stopwatch').classList.toggle('active', mode === 'stopwatch');
            },

            selectSound(type) {
                STATE.sound = type;
                document.querySelectorAll('.alarm-option').forEach(el => el.classList.remove('selected'));
                document.querySelector(`.alarm-option[data-sound="${type}"]`).classList.add('selected');
                if(STATE.muted) this.toggleMute();
            },

            previewSound(type) { SoundGen.play(type); },

            playAlarm() {
                if(STATE.muted) return;
                SoundGen.play(STATE.sound);
                const delay = STATE.sound === 'gong' ? 3500 : 2000;
                setTimeout(() => { if(!STATE.timer.running && STATE.timer.remaining <= 0) SoundGen.play(STATE.sound); }, delay);
            },

            syncTimer() {
                const h = parseInt(this.els.inputs.h.value) || 0;
                const m = parseInt(this.els.inputs.m.value) || 0;
                const s = parseInt(this.els.inputs.s.value) || 0;
                STATE.timer.total = h * 3600 + m * 60 + s;
                STATE.timer.remaining = STATE.timer.total;
            },

            updateTimerUI(sec) {
                if (sec < 0) sec = 0;
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                const s = sec % 60;
                this.els.inputs.h.value = h.toString().padStart(2,'0');
                this.els.inputs.m.value = m.toString().padStart(2,'0');
                this.els.inputs.s.value = s.toString().padStart(2,'0');
            },

            addTime(s) {
                if(STATE.timer.running) {
                    STATE.timer.remaining += s;
                    this.updateTimerUI(STATE.timer.remaining);
                } else {
                    this.syncTimer();
                    STATE.timer.total += s;
                    STATE.timer.remaining = STATE.timer.total;
                    this.updateTimerUI(STATE.timer.total);
                }
            },

            toggleTimer() {
                if(STATE.timer.running) {
                    clearInterval(STATE.timer.interval);
                    STATE.timer.running = false;
                    document.getElementById('t-start').innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
                    this.els.timerDisplay.classList.remove('danger-zone');
                    releaseWakeLock();
                } else {
                    this.syncTimer();
                    if(STATE.timer.remaining <= 0) return;
                    STATE.timer.running = true;
                    document.getElementById('t-start').innerHTML = '<span class="material-icons-outlined">pause</span>';
                    activateWakeLock();
                    STATE.timer.interval = setInterval(() => {
                        STATE.timer.remaining--;
                        this.updateTimerUI(STATE.timer.remaining);
                        
                        if(STATE.timer.remaining <= 10 && STATE.timer.remaining > 0) this.els.timerDisplay.classList.add('danger-zone');
                        if(STATE.timer.remaining <= 0) {
                            clearInterval(STATE.timer.interval);
                            STATE.timer.running = false;
                            document.getElementById('t-start').innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
                            this.els.timerDisplay.classList.remove('danger-zone');
                            this.playAlarm();
                            releaseWakeLock();
                        }
                    }, 1000);
                }
            },

            resetTimer() {
                clearInterval(STATE.timer.interval);
                STATE.timer.running = false;
                STATE.timer.remaining = 0;
                this.updateTimerUI(0);
                document.getElementById('t-start').innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
                this.els.timerDisplay.classList.remove('danger-zone');
                releaseWakeLock();
            },

            formatSW(ms) {
                const total = Math.floor(ms/1000);
                const m = Math.floor(total/60).toString().padStart(2,'0');
                const s = (total%60).toString().padStart(2,'0');
                const cs = Math.floor((ms%1000)/10).toString().padStart(2,'0');
                return `${m} <span class="separator">:</span> ${s} <span class="separator">:</span> ${cs}`;
            },

            toggleStopwatch() {
                if(STATE.stopwatch.running) {
                    clearInterval(STATE.stopwatch.interval);
                    STATE.stopwatch.running = false;
                    STATE.stopwatch.elapsed += Date.now() - STATE.stopwatch.startT;
                    document.getElementById('sw-start').innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
                    releaseWakeLock();
                } else {
                    STATE.stopwatch.startT = Date.now();
                    STATE.stopwatch.running = true;
                    document.getElementById('sw-start').innerHTML = '<span class="material-icons-outlined">pause</span>';
                    activateWakeLock();
                    STATE.stopwatch.interval = setInterval(() => {
                        const diff = (Date.now() - STATE.stopwatch.startT) + STATE.stopwatch.elapsed;
                        this.els.swDisplay.innerHTML = this.formatSW(diff);
                    }, 30);
                }
            },

            resetStopwatch() {
                clearInterval(STATE.stopwatch.interval);
                STATE.stopwatch.running = false;
                STATE.stopwatch.elapsed = 0;
                this.els.swDisplay.innerHTML = '00 <span class="separator">:</span> 00 <span class="separator">:</span> 00';
                document.getElementById('sw-start').innerHTML = '<span class="material-icons-outlined">play_arrow</span>';
                document.getElementById('laps').innerHTML = '';
                releaseWakeLock();
            },

            lap() {
                if(!STATE.stopwatch.running && STATE.stopwatch.elapsed === 0) return;
                const diff = STATE.stopwatch.running ? (Date.now() - STATE.stopwatch.startT) + STATE.stopwatch.elapsed : STATE.stopwatch.elapsed;
                const row = document.createElement('div');
                row.className = 'lap-row';
                row.innerHTML = `<span>Lap ${document.getElementById('laps').children.length + 1}</span> <span>${this.formatSW(diff)}</span>`;
                document.getElementById('laps').prepend(row);
            }
        };

        app.init();
    </script>
</body>
</html>
